{% assign sec_id = '#shopify-section-' | append: section.id %}

<div id="{{ sec_id | remove: '#' }}">
  <testimonial-slider data-section-id="{{ section.id }}"></testimonial-slider>
</div>

<style>
{{ sec_id }} testimonial-slider {
  display: block;
  position: relative;
  width: 100%;
  overflow: hidden;
  max-width: {{ section.settings.page_width }}px;
  margin-left: auto;
  margin-right: auto;
  background-color: {{ section.settings.background_color }};
  padding: {{ section.settings.desktop_padding_top }}px {{ section.settings.desktop_padding_sides }}px {{ section.settings.desktop_padding_bottom }}px;
  color: {{ section.settings.text_color }};
  font-family: {{ section.settings.type_header_font }};
}
{{ sec_id }} .pc-container {
  display: flex;
  gap: {{ section.settings.slide_gap }}px;
  transition: transform 0.5s ease;
  will-change: transform;
}
{{ sec_id }} .pc-slide {
  flex: 0 0 30%;
  min-width: 30%;
  background: {{ section.settings.slide_background }};
  border-radius: {{ section.settings.slide_border_radius }}px;
  box-shadow: {{ section.settings.slide_box_shadow }};
  padding: {{ section.settings.slide_padding_top }}px {{ section.settings.slide_padding_sides }}px {{ section.settings.slide_padding_bottom }}px;
  text-align: center;
  overflow: hidden;
}
{{ sec_id }} .pc-main-image {
  width: 100%;
  height: {{ section.settings.main_image_height }}px;
  object-fit: cover;
  border-radius: {{ section.settings.main_image_border_radius }}px {{ section.settings.main_image_border_radius }}px 0 0;
  margin-bottom: {{ section.settings.main_image_margin_bottom }}px;
}
{{ sec_id }} .pc-small-image {
  width: {{ section.settings.small_image_size }}px;
  height: {{ section.settings.small_image_size }}px;
  object-fit: cover;
  border-radius: 50%;
  margin-top: {{ section.settings.small_image_margin_top }}px;
  margin-bottom: {{ section.settings.small_image_margin_bottom }}px;
}
{{ sec_id }} .pc-check-post {
  display: inline-block;
  padding: 8px 15px;
  background-color: {{ section.settings.button_background }};
  color: {{ section.settings.button_text_color }};
  border-radius: {{ section.settings.button_border_radius }}px;
  text-decoration: none;
  font-size: {{ section.settings.button_font_size }}px;
  margin-top: {{ section.settings.button_margin_top }}px;
}
{{ sec_id }} .pc-social-links a {
  margin: 0 {{ section.settings.social_icon_gap }}px;
  font-size: {{ section.settings.social_icon_size }}px;
  text-decoration: none;
}
{{ sec_id }} .pc-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background-color: {{ section.settings.arrow_background }};
  color: {{ section.settings.arrow_color }};
  border-radius: 50%;
  width: {{ section.settings.arrow_size }}px;
  height: {{ section.settings.arrow_size }}px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: {{ section.settings.arrow_font_size }}px;
  cursor: pointer;
  z-index: 10;
}
{{ sec_id }} .pc-arrow.pc-left {
  left: {{ section.settings.arrow_offset_sides }}px;
}
{{ sec_id }} .pc-arrow.pc-right {
  right: {{ section.settings.arrow_offset_sides }}px;
}
{{ sec_id }} .pc-arrow:hover {
  background-color: {{ section.settings.arrow_hover_background }};
  color: {{ section.settings.arrow_hover_color }};
}
@media (max-width: 768px) {
  {{ sec_id }} testimonial-slider {
    padding: {{ section.settings.mobile_padding_top }}px {{ section.settings.mobile_padding_sides }}px {{ section.settings.mobile_padding_bottom }}px;
  }
  {{ sec_id }} .pc-container {
    overflow-x: auto;
    scroll-snap-type: x mandatory;
  }
  {{ sec_id }} .pc-slide {
    flex: 0 0 80%;
    min-width: 80%;
    scroll-snap-align: center;
  }
  {{ sec_id }} .pc-arrow {
    display: none;
  }
}
</style>

<script>
class TestimonialSlider extends HTMLElement {
  connectedCallback() {
    const sectionId = this.dataset.sectionId;
    const wrapper = document.querySelector(`#shopify-section-${sectionId}`);
    const leftArrow = document.createElement('div');
    leftArrow.classList.add('pc-arrow', 'pc-left');
    leftArrow.innerHTML = wrapper.querySelector('.pc-arrow.pc-left').innerHTML;
    const rightArrow = document.createElement('div');
    rightArrow.classList.add('pc-arrow', 'pc-right');
    rightArrow.innerHTML = wrapper.querySelector('.pc-arrow.pc-right').innerHTML;
    const container = document.createElement('div');
    container.classList.add('pc-container');
    const existingSlides = Array.from(wrapper.querySelectorAll('.pc-slide'));
    existingSlides.forEach(slide => container.appendChild(slide));
    wrapper.querySelectorAll('.pc-slide').forEach(el => el.remove());
    wrapper.querySelectorAll('.pc-container').forEach(el => el.remove());
    this.appendChild(leftArrow);
    this.appendChild(container);
    this.appendChild(rightArrow);
    const slides = container.querySelectorAll('.pc-slide');
    let index = 0;
    const slidesToShow = 3;
    const totalSlides = slides.length;
    const updateSlide = () => {
      if (!slides[0]) return;
      const gap = parseInt(getComputedStyle(container).getPropertyValue('gap'));
      const slideWidth = slides[0].getBoundingClientRect().width + gap;
      container.style.transform = `translateX(${-index * slideWidth}px)`;
    };
    leftArrow.addEventListener('click', () => {
      index = index > 0 ? index - 1 : totalSlides - slidesToShow;
      updateSlide();
    });
    rightArrow.addEventListener('click', () => {
      index = index < totalSlides - slidesToShow ? index + 1 : 0;
      updateSlide();
    });
    if ({{ section.settings.autoplay_enabled | default: false }}) {
      const intervalSpeed = {{ section.settings.autoplay_speed }};
      this._autoPlayInterval = setInterval(() => {
        index = index < totalSlides - slidesToShow ? index + 1 : 0;
        updateSlide();
      }, intervalSpeed);
    }
    updateSlide();
  }
  disconnectedCallback() {
    if (this._autoPlayInterval) clearInterval(this._autoPlayInterval);
  }
}
if (!customElements.get('testimonial-slider')) {
  customElements.define('testimonial-slider', TestimonialSlider);
}
</script>

<div class="pc-arrow pc-left">{{ section.settings.left_arrow_text }}</div>
<div class="pc-container">
  {% for block in section.blocks %}
    <div class="pc-slide">
      {% if block.settings.image != blank %}
        <img class="pc-main-image" src="{{ block.settings.image | img_url: '600x600' }}" alt="{{ block.settings.name }}" />
      {% else %}
        {{ 'product-1' | placeholder_svg_tag }}
      {% endif %}
      <div style="text-align: {{ block.settings.alignment }};">
        {% if block.settings.small_image != blank %}
          <img class="pc-small-image" src="{{ block.settings.small_image | img_url: '70x70' }}" alt="{{ block.settings.name }}" />
        {% else %}
          {{ 'product-1' | placeholder_svg_tag }}
        {% endif %}
        <h3 style="font-size: {{ block.settings.name_font_size }}px; margin: {{ block.settings.name_margin_top }}px 0;">{{ block.settings.name }}</h3>
        <p style="font-size: {{ block.settings.role_font_size }}px; margin: {{ block.settings.role_margin_top }}px 0;">{{ block.settings.role }}</p>
        <p style="font-size: {{ block.settings.testimonial_font_size }}px; margin: {{ block.settings.testimonial_margin_top }}px 0;">{{ block.settings.testimonial_text }}</p>
        {% if block.settings.post_link %}
          <a href="{{ block.settings.post_link }}" class="pc-check-post">+ {{ section.settings.post_button_text }}</a>
        {% endif %}
        <div class="pc-social-links" style="margin-top: {{ block.settings.social_margin_top }}px;">
          {% if block.settings.instagram_link %}
            <a href="{{ block.settings.instagram_link }}" target="_blank" style="color: {{ section.settings.instagram_icon_color }};">Instagram</a>
          {% endif %}
          {% if block.settings.youtube_link %}
            <a href="{{ block.settings.youtube_link }}" target="_blank" style="color: {{ section.settings.youtube_icon_color }};">YouTube</a>
          {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}
</div>
<div class="pc-arrow pc-right">{{ section.settings.right_arrow_text }}</div>

{% schema %}
{
  "name": "PC - Testimonial Slider",
  "settings": [
    {
      "type": "range",
      "id": "page_width",
      "label": "Max Page Width (px)",
      "min": 600,
      "max": 1600,
      "step": 50,
      "default": 1200
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Section Background Color",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#333333"
    },
    {
      "type": "font_picker",
      "id": "type_header_font",
      "default": "assistant_n4",
      "label": "Font Family"
    },
    {
      "type": "range",
      "id": "desktop_padding_top",
      "label": "Top Padding (Desktop)",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 40
    },
    {
      "type": "range",
      "id": "desktop_padding_sides",
      "label": "Side Padding (Desktop)",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "desktop_padding_bottom",
      "label": "Bottom Padding (Desktop)",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 40
    },
    {
      "type": "range",
      "id": "mobile_padding_top",
      "label": "Top Padding (Mobile)",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "mobile_padding_sides",
      "label": "Side Padding (Mobile)",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 10
    },
    {
      "type": "range",
      "id": "mobile_padding_bottom",
      "label": "Bottom Padding (Mobile)",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "slide_gap",
      "label": "Gap Between Slides (px)",
      "min": 0,
      "max": 50,
      "step": 5,
      "default": 20
    },
    {
      "type": "color",
      "id": "slide_background",
      "label": "Slide Background Color",
      "default": "#FFFFFF"
    },
    {
      "type": "text",
      "id": "slide_box_shadow",
      "label": "Slide Box Shadow (CSS)",
      "default": "0px 4px 8px rgba(0,0,0,0.1)"
    },
    {
      "type": "range",
      "id": "slide_border_radius",
      "label": "Slide Border Radius (px)",
      "min": 0,
      "max": 50,
      "step": 2,
      "default": 10
    },
    {
      "type": "range",
      "id": "slide_padding_top",
      "label": "Slide Padding Top (px)",
      "min": 0,
      "max": 50,
      "step": 5,
      "default": 20
    },
    {
      "type": "range",
      "id": "slide_padding_sides",
      "label": "Slide Padding Sides (px)",
      "min": 0,
      "max": 50,
      "step": 5,
      "default": 20
    },
    {
      "type": "range",
      "id": "slide_padding_bottom",
      "label": "Slide Padding Bottom (px)",
      "min": 0,
      "max": 50,
      "step": 5,
      "default": 20
    },
    {
      "type": "range",
      "id": "main_image_height",
      "label": "Main Image Height (px)",
      "min": 100,
      "max": 600,
      "step": 50,
      "default": 300
    },
    {
      "type": "range",
      "id": "main_image_border_radius",
      "label": "Main Image Border Radius (px)",
      "min": 0,
      "max": 50,
      "step": 5,
      "default": 10
    },
    {
      "type": "range",
      "id": "main_image_margin_bottom",
      "label": "Main Image Bottom Margin (px)",
      "min": 0,
      "max": 50,
      "step": 5,
      "default": 10
    },
    {
      "type": "range",
      "id": "small_image_size",
      "label": "Avatar Size (px)",
      "min": 30,
      "max": 150,
      "step": 10,
      "default": 70
    },
    {
      "type": "range",
      "id": "small_image_margin_top",
      "label": "Avatar Top Margin (px)",
      "min": 0,
      "max": 30,
      "step": 5,
      "default": 10
    },
    {
      "type": "range",
      "id": "small_image_margin_bottom",
      "label": "Avatar Bottom Margin (px)",
      "min": 0,
      "max": 30,
      "step": 5,
      "default": 10
    },
    {
      "type": "text",
      "id": "post_button_text",
      "label": "Check-Full-Post Button Text",
      "default": "Check full post"
    },
    {
      "type": "color",
      "id": "button_background",
      "label": "Button Background Color",
      "default": "#FFD700"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#333333"
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "label": "Button Border Radius (px)",
      "min": 0,
      "max": 50,
      "step": 5,
      "default": 5
    },
    {
      "type": "range",
      "id": "button_font_size",
      "label": "Button Font Size (px)",
      "min": 10,
      "max": 24,
      "step": 1,
      "default": 14
    },
    {
      "type": "range",
      "id": "button_margin_top",
      "label": "Button Top Margin (px)",
      "min": 0,
      "max": 30,
      "step": 5,
      "default": 10
    },
    {
      "type": "color",
      "id": "instagram_icon_color",
      "label": "Instagram Icon Color",
      "default": "#E4405F"
    },
    {
      "type": "color",
      "id": "youtube_icon_color",
      "label": "YouTube Icon Color",
      "default": "#FF0000"
    },
    {
      "type": "range",
      "id": "social_icon_size",
      "label": "Social Icon Size (px)",
      "min": 12,
      "max": 36,
      "step": 2,
      "default": 20
    },
    {
      "type": "range",
      "id": "social_icon_gap",
      "label": "Social Icon Gap (px)",
      "min": 0,
      "max": 20,
      "step": 2,
      "default": 8
    },
    {
      "type": "text",
      "id": "left_arrow_text",
      "label": "Left Arrow Text (HTML Entities OK)",
      "default": "&#10094;"
    },
    {
      "type": "text",
      "id": "right_arrow_text",
      "label": "Right Arrow Text (HTML Entities OK)",
      "default": "&#10095;"
    },
    {
      "type": "color",
      "id": "arrow_background",
      "label": "Arrow Background",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "arrow_color",
      "label": "Arrow Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "arrow_hover_background",
      "label": "Arrow Hover Background",
      "default": "#dddddd"
    },
    {
      "type": "color",
      "id": "arrow_hover_color",
      "label": "Arrow Hover Color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "arrow_size",
      "label": "Arrow Size (px)",
      "min": 24,
      "max": 60,
      "step": 4,
      "default": 40
    },
    {
      "type": "range",
      "id": "arrow_font_size",
      "label": "Arrow Font Size (px)",
      "min": 12,
      "max": 36,
      "step": 2,
      "default": 20
    },
    {
      "type": "range",
      "id": "arrow_offset_sides",
      "label": "Arrow Offset from Sides (px)",
      "min": 0,
      "max": 50,
      "step": 5,
      "default": 10
    },
    {
      "type": "checkbox",
      "id": "autoplay_enabled",
      "label": "Enable Autoplay?",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Autoplay Speed (ms)",
      "min": 2000,
      "max": 9000,
      "step": 500,
      "unit": "ms",
      "default": 5000
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Profile Image"
        },
        {
          "type": "select",
          "id": "alignment",
          "label": "Content Alignment",
          "options": [
            { "value": "left", "label": "Left" },
            { "value": "center", "label": "Center" },
            { "value": "right", "label": "Right" }
          ],
          "default": "center"
        },
        {
          "type": "image_picker",
          "id": "small_image",
          "label": "Avatar (Small Image)"
        },
        {
          "type": "text",
          "id": "name",
          "label": "Name",
          "default": "John Doe"
        },
        {
          "type": "range",
          "id": "name_font_size",
          "label": "Name Font Size (px)",
          "min": 14,
          "max": 28,
          "step": 1,
          "unit": "px",
          "default": 18
        },
        {
          "type": "range",
          "id": "name_margin_top",
          "label": "Name Top Margin (px)",
          "min": 0,
          "max": 30,
          "step": 2,
          "unit": "px",
          "default": 10
        },
        {
          "type": "text",
          "id": "role",
          "label": "Role",
          "default": "Designer"
        },
        {
          "type": "range",
          "id": "role_font_size",
          "label": "Role Font Size (px)",
          "min": 12,
          "max": 24,
          "step": 1,
          "unit": "px",
          "default": 14
        },
        {
          "type": "range",
          "id": "role_margin_top",
          "label": "Role Top Margin (px)",
          "min": 0,
          "max": 30,
          "step": 2,
          "unit": "px",
          "default": 8
        },
        {
          "type": "textarea",
          "id": "testimonial_text",
          "label": "Testimonial Text",
          "default": "This is the best service Iâ€™ve ever used!"
        },
        {
          "type": "range",
          "id": "testimonial_font_size",
          "label": "Testimonial Font Size (px)",
          "min": 12,
          "max": 20,
          "step": 1,
          "unit": "px",
          "default": 16
        },
        {
          "type": "range",
          "id": "testimonial_margin_top",
          "label": "Testimonial Top Margin (px)",
          "min": 0,
          "max": 30,
          "step": 2,
          "unit": "px",
          "default": 8
        },
        {
          "type": "url",
          "id": "post_link",
          "label": "Link to Full Post"
        },
        {
          "type": "range",
          "id": "social_margin_top",
          "label": "Social Links Top Margin (px)",
          "min": 0,
          "max": 30,
          "step": 2,
          "unit": "px",
          "default": 10
        },
        {
          "type": "url",
          "id": "instagram_link",
          "label": "Instagram Link"
        },
        {
          "type": "url",
          "id": "youtube_link",
          "label": "YouTube Link"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Default Four Testimonials",
      "category": "Testimonials",
      "blocks": [
        { "type": "testimonial" },
        { "type": "testimonial" },
        { "type": "testimonial" },
        { "type": "testimonial" }
      ]
    }
  ]
}
{% endschema %}
